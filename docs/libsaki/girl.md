---
layout: page
title: 角色能力
permalink: /docs/libsaki/girl/
---

角色能力是通过一个回调接口`Girl`实现的。
每一个角色都对应一个`Girl`的子类。
`Girl`及其子类定义在`libsaki/girl`目录中。

`libsaki/girl`里的文件以学校为单位（否则小文件太多），
个别代码较多的角色可抽象出一些小组件，
再把小组件放到单独的文件中。

<br />

## FAQ

- 如何修改现有角色的一个技能？
    - 参考`libsaki/girl`里的各种现有技能，照葫芦画瓢。
- 如何创建新角色？
    - 第一步：在`mjpancake/qrc/qml/js/girlnames.js`中修改`availIds`，
              使新角色的ID出现在选人列表里。
    - 第二步：创建新的`Girl`子类和对应的`Girl::Id`枚举
    - 第三步：在`Girl::create()`里将新类与ID枚举关联起来。
    - 第四部：在`Girl`子类中实现新人物的技能。

<br />

## Girl ID 的分配规律

京狗的 ID 是 0。

所有 71 届 IH 的出场人物都使用 71xxyz 的 6 位数 ID。
其中 xxyz 意义如下：
- xx 代表县或赛区的抽签号码，例如长野是 33，奈良是 24。
- y 代表县排名，例如清澄是 1，龙门渕是 2。
- z 代表团体战出场位置，先锋到大将分别对应 1 到 5

举例：魔王 713315，鸭子 712415，红帽 715215，笨淡 710115。

出场位置不明的，或者学校未参加团体战的，或者学校县排名不明的，
使用 71xx0w 形式，其中 xx 为县抽签号码，w 代表制作序号。

61 届 IH 出场人物能用 61xxyz 格式的也都用这个格式。

其余角色用 99wwww 格式，wwww 代表无特殊意义的序列号，按顺序分配。

<br />

## 回调函数及其被调用时机

|---------------------|--------------|------------------|
| 函数名              | 调用时机     | 主要用于实现     |
|---------------------|--------------|------------------|
|`onDice`             |掷骰子前      |掷骰子前发动的挂  |
|`onActivate`         |操作者被激活前|附加主动技能按钮  |
|`onDraw`             |摸牌前        |控制自己或他家进张|
|`onChooseFirstDealer`|起家被选出前  |卷饼起家          |
|`onDiscarded`        |打牌后        |跟打出的牌有关的挂|
|`onRiichiEstablished`|立直通过后    |跟立直有关的挂    |
|`onRoundEnded`       |一局结束后    |跟过去点数有关的挂|

<br />

注意有些回调发生在“某事前”，有些发生在“某事后”。
一般函数名为"do something"形式的都是“前”，"something done"的都是“后”。

绝大多数能力都是通过重写`onDraw`实现的——在摸牌前干涉牌山，从而搞事情。

配牌挂是借助`Princess`实现的，我们会在发牌姬的文档中详细说明。

<br />

## Girl 的其它虚函数

|---------------|----------------|--------------|
| 函数名        | 用途           | 调用时机 |
|---------------|----------------|-------------|
|`forwardAction`|行动转发        |发生“行动转发”时|
|`irsCheckRow`  |提供能力选项行  |外部随意调用，时机无法预测|
|`irsCheckCount`|返回能力选项行数|外部随意调用，时机无法预测|
|`popUpStr`     |返回感知能力信息|外部随意调用，时机无法预测|
|`onMonkey`     |干涉配牌        |发牌姬文档中会详细说明|
|`checkInit`    |审查配牌        |发牌姬文档中会详细说明|
|`nonMonkey`    |定制配牌        |发牌姬文档中会详细说明|

<br />

## 行动转发

`Table`作为正常的麻将逻辑，只能处理打牌、鸣牌等正常的操作，
不应该知道除此之外的，主动技能的处理方式。
因此每当`Table`收到主动技能操作，都会转发给对应的`Girl`处理。
所谓的“转发”，就是调用`Girl::forwardAction`方法。
带有主动技能的角色都必须实现`forwardAction`方法，
否则会导致未定义后果。

`forwardAction`的返回值是一个`Choices`，
代表该操作者“下一步能做什么”。
例如，爽在按下加号按钮后，下一步应选择开哪个挂；
淡在决定是否开启W立模式后，下一步应该恢复正常的切牌操作。

所有的主动技能最终都应该让操作回到正常的麻将流程上去，
所以总会有一次`forwardAction`的调用要返回一个正常的`Choices`。
这个“正常的`Choices`“需要由`Girl`在打乱流程之前自行保存备份，
并在开完挂以后通过`forwardAction`的返回值去恢复。
因此如果哪个`Girl`没有做好这个备份恢复工作，
就会导致牌桌从正常的逻辑上离开并且永远回不来。
也就是说`Girl`有一部分保持`Table`正常运转的责任
—— 按理来讲`Table`的运转正常性应该完全由`Table`承担，
这是目前的 Libsaki 架构上的设计失败，将来会修改。




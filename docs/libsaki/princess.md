---
layout: page
title: 发牌姬
permalink: /docs/libsaki/princess/
---

发牌姬`Princess`定义在`libsaki/table/princess.h`。

发牌姬并非一个看得见、摸得着的实体，
只是有关发牌的逻辑比较多，所以才单独分出了一个`Princess`类。
`Princess`对象在每次发牌前创建，维护一些有关发牌过程的变量，
最终在该次发牌结束时销毁。

`Princess`是目前 Libsaki 中的一个比较失败的设计，
既不容易修改，改起来又容易出错。将来发牌姬部分会有较大变动。

<br />

## 发牌过程

目前的发牌过程由以下几步组成：

1. 非猴子阶段
    1. 前宝牌非猴阶段
    2. 宝牌预约阶段
    3. 后宝牌非猴阶段
2. 猴子阶段

我们先解释猴子阶段，再解释非猴子阶段。

<br />

## 猴子阶段

“猴子”指的是猴子算法。猴子算法的思想大致是这样的：
```
do {
    结果 = 随机生成();
} while (!满意(结果));
```

放到配牌的问题下，猴子算法就是这样：
```
for (int i = 0; i < 4; i++) {
    do {
        临时配牌 = 随机生成();
    } while (!所有Girl满意(临时配牌));
    操作者i的配牌 = 临时配牌；
}
```

“所有的Girl满意“指的是 4 个`Girl`的`checkInit()`函数都返回`true`。
也就是说，`checkInit`不仅可以对自己的配牌表达不满，
还可以对别人的配牌表达不满，从此控制自己和他家的配牌。

`checkInit`还有一个`iter`参数，表示当前是第几轮生成。
我们约定：所有`Girl`的`checkInit`都必须在`iter`达到一个大数时返回`true`，
也就是放弃继续表达任何不满，从而无条件接受下一轮生成的配牌。
这有两个作用，一是避免死循环，二是刻画配牌挂的“毅力”。
弃疗的`iter`阈值越大，技能的毅力就越强，成功率就越高。

`Girl`还有一个和猴子阶段相关的回调`onMonkey()`。
这个回调的使用方式和`onDraw()`是类似的，
通过干涉牌山调整摸到各种牌的概率。

### 猴子算法的优劣

猴子算法常用于理论教学和玩梗，
不过在我们这个应用场景下倒是非常的合适，原因如下：

- 猴子算法可以涵盖所有可能的配牌  
  PSV 中存在“配牌感觉老是那几个套路”的问题，
  因为配牌结果面涵盖过小，缺乏多样性。
  满足一个技能所规定的条件的配牌结果数其实相当地多，
  设计一种能够涵盖所有可能情况的主动生成算法并不容易。
  而“被动生成 + 筛选”则是一个简单有效的方式。
  因为被动生成没有任何方向性，理论上存在的配牌都有可能被生成出来。
- 未被约束的因素应保持自然分布  
  即使我们设计了一个能涵盖所有情况的主动生成算法，
  这些结果出现的概率分布的自然性也是没法得以保证的。
  例如，我们的目标是生成一个“万字混一色手牌”，由于目标对其它因素只字未提，
  我们应当使结果保持正常的向听数概率分布和字牌比例。
  如果采用了主动式生成算法，这些问题不仅都需要处理，
  对于处理是否成功的验证也是一个问题；
  而如果使用“被动生成 + 筛选”，这些性质已自动具备，不需再管。
- 基于放弃检测矛盾  
  有时角色间的能力存在逻辑矛盾。如果采用主动式生成，
  必须设计一套精巧的机制检测并解决这些矛盾。
  但用了基于`iter`放弃的猴子算法，所有的一切已自动完成。
  可妥协的能力可在`iter`变大时放宽条件，
  不可妥协的能力可以多坚持几个`iter`。
  而”明明没有矛盾，却因为运气不好而导致`iter`过多失败“则是一个小概率事件，
  我们可以想办法把这个概率降低到天麻动画出第四季的概率以下，
  这样一来解决这个问题的优先度就低于准备看天麻第四季了。
  （真是没办法啊……淫神威！）

以上是猴子算法的优点。
要说缺点，其实就是慢。除了慢没别的毛病。

因为太慢，4 家配牌是依次被决定的——前一家的配牌确定后，再生成下一家的配牌。
其实最合理的方式是这样的：
```
do {
    配牌1 = 随机生成();
    配牌2 = 随机生成();
    配牌3 = 随机生成();
    配牌4 = 随机生成();
} while (!所有人对所有牌满意);
```
也就是“稍有不满，四家重来”——而我们现在是“稍有不满，一家重来”。
比起一家重来，四家重来的组合数更多、更自由，结果的涵盖面也更广。
但是四家重来实在是太慢了。

为了解决猴子算法过慢的问题，我们在猴子阶段前面加了个“非猴子阶段”。
（非猴子阶段同时也解决一些其它问题）

<br />

## 非猴子阶段

整个非猴子阶段，以宝牌问题为中心，被分成了三个子阶段：

1. 前宝牌非猴阶段
2. 宝牌预约阶段
3. 后宝牌非猴阶段

我们先解释中间的宝牌预约阶段。

<br />

### 宝牌预约阶段

很多技能对宝牌指示牌有要求
—— 这里我们指包括表、里、杠表、杠里在内的所有指示牌。
有些角色的指示牌要求是打牌中途产生的，
这些技能通过普通的`Girl`回调就能实现；
而有些对指示牌的要求是从配牌前就开始产生了的，
这些能力必须在配牌阶段发动。
“宝牌预约阶段”就是针对这些在配牌阶段对指示牌的要求而设计的。

对指示牌的要求有三种：无要求、内定要求、可壁性内定要求。

*可壁（Wallable）*和*可壁性（Wallability）*这两个词在代码和文档中很常用。
可壁指的就是“山里 A 区还剩4张（不区分赤黑）”。

目前只有玄和淡用到了宝牌预约阶段，
因此这些逻辑暂时写死到了`doraMatters()`里。
将来会大改。

详细的文档会在大改后补充。

### 后宝牌非猴阶段

（待续）

### 前宝牌非猴阶段

（待续）


